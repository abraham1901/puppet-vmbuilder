#!/bin/bash
# This script will run the first time the virtual machine boots
# It is ran as root.
 
# Regenerate ssh keys
rm /etc/ssh/ssh_host*key*
dpkg-reconfigure -fnoninteractive -pcritical openssh-server
echo '# include /etc/sudoers.d' >> /etc/sudoers

sed -e '/logdir/ a pluginsync=true' -i /etc/puppet/puppet.conf 
sed -e "/logdir/ a server=<%= puppetmaster %>" -i /etc/puppet/puppet.conf
sed -e 's/START=no/START=yes/' -i /etc/default/puppet 
puppet agent --test --waitforcert 0 || true
echo -e "server <%= puppetmaster %> iburst" > /etc/ntp.conf 
echo '8021q' >> /etc/modules
echo 'kvm' >> /etc/modules

mkdir /root/.ssh
cat >> /root/.ssh/authorized_keys <<EOF
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCeS9zlMeXeivRadLQPLkKevr4wgwckKWr7/M2duvAwNNUmksQTwdfgyA9olciY4LAtn1CRFt4eU7gXOkbP9c0iUTvn/R7Rsva29W/NyXAKIF56PEEZ77FHlXyifuOgRiaRHZMz7sbMFsiXhgwwOl/fsA8pCGOo7VZ5Y088Bwcec0xpm8doxgTZoHtBGcskYX3OiAcYr/dJqzvJmtPwTUtjpWlk9pTSrnedxgKh9XKndKEE3ewjsTAmtpAkdw5gdaUCmJMM4U+o86QIxTNy67ITjoFnsNlspxDiTlrPGn8D6Xt4VLWvus8WbeR5Rv9vz+WPHJT0nMnrsG0hnVCDLe2p root@control01
EOF
chmod 600 /root/.ssh/authorized_keys
